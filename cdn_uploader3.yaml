name: Model CDN uploader v3
inputs:
  - {name: model_pickle, type: Model, description: "Saved model pickle/joblib file to upload"}
  - {name: bearer_token, type: string, description: "Path to a file containing bearer token (will be read)"}
  - {name: domain, type: String, description: "Domain root for upload endpoint, e.g. https://api.example.com"}
  - {name: get_cdn, type: String, description: "CDN base URL to prefix returned relative cdnUrl"}
  - {name: name, type: String, description: "Friendly name to include in schema CDN JSON", optional: false}

outputs:
  - {name: schema_cdn_json, type: String, description: "JSON containing the model_pickle_cdn and name"}
  - {name: config_cdn_url, type: String, description: "JSON containing config with model_weights_cdn"}

implementation:
  container:
    image: gurpreetgandhi/nesy-factory:vtests3
    command:
      - python3
      - -u
      - -c
      - |
        import argparse
        import subprocess
        import json
        import os
        import uuid
        import tempfile
        import shutil
        import sys
        import traceback

        parser = argparse.ArgumentParser(description="Upload model to CDN and emit config JSON.")
        parser.add_argument('--model_pickle', type=str, required=True)
        parser.add_argument('--bearer_token', type=str, required=True)
        parser.add_argument('--domain', type=str, required=True)
        parser.add_argument('--get_cdn', type=str, required=True)
        parser.add_argument('--name', type=str, required=True)

        parser.add_argument('--schema_cdn_json', type=str, required=True)
        parser.add_argument('--config_cdn_url', type=str, required=True)
        args = parser.parse_args()

        def ensure_parent_dir(path):
            parent = os.path.dirname(path)
            if parent:
                os.makedirs(parent, exist_ok=True)

        def atomic_write_json(path, data):
            ensure_parent_dir(path)
            dirp = os.path.dirname(path) or tempfile.gettempdir()
            fd, tmp = tempfile.mkstemp(prefix="tmp_json_", dir=dirp)
            try:
                with os.fdopen(fd, "w", encoding="utf-8") as f:
                    json.dump(data, f, ensure_ascii=False)
                os.replace(tmp, path)
            except Exception:
                try:
                    os.remove(tmp)
                except Exception:
                    pass
                raise

        # Read bearer token
        with open(args.bearer_token, "r", encoding="utf-8") as f:
            bearer_token = f.read().strip()

        upload_url = (
            f"{args.domain.rstrip('/')}"
            "/mobius-content-service/v1.0/content/upload"
            "?filePathAccess=private&filePath=%2Fbottle%2Flimka%2Fsoda%2F"
        )

        def run_curl_upload(file_path):
            cmd = [
                "curl",
                "--location", upload_url,
                "--header", f"Authorization: Bearer {bearer_token}",
                "--form", f"file=@{file_path}",
                "--fail",
                "--show-error"
            ]
            proc = subprocess.run(cmd, capture_output=True)
            stdout = proc.stdout.decode("utf-8", errors="ignore")
            stderr = proc.stderr.decode("utf-8", errors="ignore")
            if proc.returncode != 0:
                raise RuntimeError(f"curl failed:{stderr}{stdout}")
            return json.loads(stdout)

        def prepare_path_for_upload(input_path):
            if not os.path.exists(input_path):
                raise FileNotFoundError(input_path)
            if os.path.isfile(input_path):
                return input_path, None

            tmpzip = os.path.join(
                tempfile.gettempdir(),
                f"model_{uuid.uuid4().hex}.zip"
            )
            shutil.make_archive(tmpzip.replace(".zip", ""), "zip", root_dir=input_path)
            return tmpzip, tmpzip

        try:
            tmp = None

            prepared, tmp = prepare_path_for_upload(args.model_pickle)
            resp = run_curl_upload(prepared)

            rel = resp.get("cdnUrl")
            if not rel:
                raise ValueError("Missing cdnUrl in upload response")

            final_url = f"{args.get_cdn.rstrip('/')}{rel}"

            # schema JSON contains both model_pickle_cdn and name (name is required)
            schema_out = {
                "model_url": final_url,
                "name": args.name
            }
            atomic_write_json(args.schema_cdn_json, schema_out)

            config_out = {"model_weights_cdn": final_url}
            atomic_write_json(args.config_cdn_url, config_out)

            print("[INFO] Upload complete")
            print("[CDN] Model:", final_url)

        except Exception as e:
            print("ERROR:", str(e), file=sys.stderr)
            traceback.print_exc()
            raise

        finally:
            if tmp and os.path.exists(tmp):
                try:
                    os.remove(tmp)
                except Exception:
                    pass
    args:
      - --model_pickle
      - {inputPath: model_pickle}
      - --bearer_token
      - {inputPath: bearer_token}
      - --domain
      - {inputValue: domain}
      - --get_cdn
      - {inputValue: get_cdn}
      - --name
      - {inputValue: name}
      - --schema_cdn_json
      - {outputPath: schema_cdn_json}
      - --config_cdn_url
      - {outputPath: config_cdn_url}
